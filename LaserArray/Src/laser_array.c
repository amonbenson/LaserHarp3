#include "laser_array.h"
#include "string.h"

/*
Table generated using the following python snippet:

import math

N_LEVELS = 32
N_BITS = max(8, 2**math.ceil(math.log2(N_LEVELS - 1)))
GAMMA = 1.5

for n in range(N_LEVELS):
    pattern = 0

    b = round(n**GAMMA / N_LEVELS**(GAMMA-1))
    for i in range(b):
        shift = N_LEVELS * i // b
        pattern |= 1 << shift

    print(f"UINT{N_BITS}_C(0b{pattern :0{N_BITS}b}),")
 */
static la_brightness_pattern_t la_brightness_patterns[LA_NUM_BRIGHTNESS_LEVELS] = {
        UINT64_C(0b0000000000000000000000000000000000000000000000000000000000000000),
        UINT64_C(0b0000000000000000000000000000000000000000000000000000000000000000),
        UINT64_C(0b0000000000000000000000000000000000000000000000000000000000000000),
        UINT64_C(0b0000000000000000000000000000000000000000000000000000000000000001),
        UINT64_C(0b0000000000000000000000000000000000000000000000000000000000000001),
        UINT64_C(0b0000000000000000000000000000000000000000000000000000000000000001),
        UINT64_C(0b0000000000000000000000000000000100000000000000000000000000000001),
        UINT64_C(0b0000000000000000000000000000000100000000000000000000000000000001),
        UINT64_C(0b0000000000000000000001000000000000000000001000000000000000000001),
        UINT64_C(0b0000000000000000000001000000000000000000001000000000000000000001),
        UINT64_C(0b0000000000000001000000000000000100000000000000010000000000000001),
        UINT64_C(0b0000000000001000000000000100000000000010000000000001000000000001),
        UINT64_C(0b0000000000001000000000000100000000000010000000000001000000000001),
        UINT64_C(0b0000000000100000000001000000000100000000001000000000010000000001),
        UINT64_C(0b0000000001000000001000000001000000001000000001000000001000000001),
        UINT64_C(0b0000000001000000001000000001000000001000000001000000001000000001),
        UINT64_C(0b0000000100000001000000010000000100000001000000010000000100000001),
        UINT64_C(0b0000000100000010000001000000100000010000001000000100000010000001),
        UINT64_C(0b0000001000001000000100000100000100000010000010000001000001000001),
        UINT64_C(0b0000001000001000000100000100000100000010000010000001000001000001),
        UINT64_C(0b0000010000010000010000010000010000100000100000100000100000100001),
        UINT64_C(0b0000010000100001000001000010000100000100001000010000010000100001),
        UINT64_C(0b0000100001000010000100001000010000100001000010000100001000010001),
        UINT64_C(0b0000100001000100001000100001000100001000010001000010001000010001),
        UINT64_C(0b0000100010001000010001000100010000100010001000100001000100010001),
        UINT64_C(0b0001000100010001000100010001000100010001000100010001000100010001),
        UINT64_C(0b0001000100010001001000100010001001000100010001001000100010001001),
        UINT64_C(0b0001000100100010010001001000100100010001001000100100010010001001),
        UINT64_C(0b0001001000100100100010010010001001000100100100010010010001001001),
        UINT64_C(0b0001001001001001000100100100100100010010010010010001001001001001),
        UINT64_C(0b0001001001001001001001001001001001001001001001001001001001001001),
        UINT64_C(0b0010010010010010010010010010010100100100100100100100100100100101),
        UINT64_C(0b0010010010010100100100100101001001001010010010010010100100100101),
        UINT64_C(0b0010010100100101001001010010010100100101001001010010010100100101),
        UINT64_C(0b0010010100101001010010010100101001010010100100101001010010100101),
        UINT64_C(0b0010100101001010010100101001010100101001010010100101001010010101),
        UINT64_C(0b0010100101010010101001010010101001010100101001010100101010010101),
        UINT64_C(0b0010101001010101001010100101010100101010010101010010101001010101),
        UINT64_C(0b0010101010010101010100101010101001010101010010101010100101010101),
        UINT64_C(0b0010101010101010010101010101010100101010101010100101010101010101),
        UINT64_C(0b0101010101010101010101010101010101010101010101010101010101010101),
        UINT64_C(0b0101010101010101010101010101010110101010101010101010101010101011),
        UINT64_C(0b0101010101010101101010101010101101010101010101011010101010101011),
        UINT64_C(0b0101010101101010101011010101010110101010101101010101011010101011),
        UINT64_C(0b0101010110101011010101011010101101010101101010110101010110101011),
        UINT64_C(0b0101011010110101101011010110101101010110101101011010110101101011),
        UINT64_C(0b0101101011010110101101101011010110101101011011010110101101011011),
        UINT64_C(0b0101101101011011010110110101101101011011010110110101101101011011),
        UINT64_C(0b0101101101101101101101101101101101011011011011011011011011011011),
        UINT64_C(0b0110110110110110110110110110110110110110110110110110110110110111),
        UINT64_C(0b0110110110110111011011011011011101101101101101110110110110110111),
        UINT64_C(0b0110111011011101101110110111011101101110110111011011101101110111),
        UINT64_C(0b0110111011101110110111011101110110111011101110110111011101110111),
        UINT64_C(0b0111011101110111011101110111011101110111011101110111011101110111),
        UINT64_C(0b0111011110111011110111011110111101110111101110111101110111101111),
        UINT64_C(0b0111011110111101111011110111101111011110111101111011110111101111),
        UINT64_C(0b0111101111011111011110111101111101111011110111110111101111011111),
        UINT64_C(0b0111110111110111111011111011111101111101111101111110111110111111),
        UINT64_C(0b0111111011111101111110111111011111101111110111111011111101111111),
        UINT64_C(0b0111111110111111110111111110111111110111111110111111110111111111),
        UINT64_C(0b0111111111011111111110111111111101111111110111111111101111111111),
        UINT64_C(0b0111111111111111011111111111111101111111111111110111111111111111),
        UINT64_C(0b0111111111111111111110111111111111111111110111111111111111111111),
        UINT64_C(0b0111111111111111111111111111111111111111111111111111111111111111)
};


HAL_StatusTypeDef LaserArray_Init(LaserArray_t *la, const LaserArray_Config_t *config) {
    HAL_StatusTypeDef ret;

    // store the config
    la->config = *config;

    // clear the data arrays
    memset(la->brightnesses, 0, sizeof(la->brightnesses));
    memset(la->tx_data, 0, sizeof(la->tx_data));

    // enable spi
    __HAL_SPI_ENABLE(la->config.hspi);

    // setup timer dma to trigger the transmission of spi data
    ret = HAL_DMA_Start_IT(la->config.htim->hdma[TIM_DMA_ID_UPDATE],
            (uint32_t) la->tx_data,
            (uint32_t) &la->config.hspi->Instance->DR,
            sizeof(la->tx_data) / sizeof(uint16_t));
    if (ret != HAL_OK) {
        return ret;
    }

    // enable dma on the timer
    __HAL_TIM_ENABLE_DMA(la->config.htim, TIM_DMA_UPDATE);

    // start the timer with pwm enabled
    ret = HAL_TIM_PWM_Start(la->config.htim, la->config.rclk_channel);
    if (ret != HAL_OK) {
        return ret;
    }

    return HAL_OK;
}

HAL_StatusTypeDef LaserArray_SetBrightness(LaserArray_t *la, uint8_t diode, uint8_t brightness) {
    // validate the parameters
    if (diode >= LA_NUM_DIODES) {
        return HAL_ERROR;
    }

    // clamp the brightness
    if (brightness >= LA_NUM_BRIGHTNESS_LEVELS) {
        brightness = LA_NUM_BRIGHTNESS_LEVELS - 1;
    }

    // lookup the brightness pattern
    la_brightness_pattern_t pattern = la_brightness_patterns[brightness];

    // iterate through each diode bitmask
    for (int i = 0; i < LA_TX_DATA_LENGTH; i++) {
        // either set or unset the corresponding bit depending on the pattern
        if ((pattern >> i) & UINT32_C(1)) {
            la->tx_data[i] |= UINT32_C(1) << diode;
        } else {
            la->tx_data[i] &= ~(UINT32_C(1) << diode);
        }
    }

    return HAL_OK;
}
